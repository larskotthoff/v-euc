<!DOCTYPE html>
<html>
    <head>
        <title>Euro crisis</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <script type="text/javascript" src="../../d3.min.js"></script>
        <script type="text/javascript" src="../../d3.layout.min.js"></script>
        <script type="text/javascript" src="../../d3.time.min.js"></script>
        <script type="text/javascript" src="../../jquery-1.6.2.min.js"></script>
        <script type="text/javascript" src="jquery-ui-1.8.16.custom.min.js"></script>
        <style type="text/css">
body {
    font: 12px Verdana, Palatino, Helvetica, sans;
}
h1 {
    font-weight: normal;
    font-size: 4em;
    margin: 0 0 0;
}
.timelabel {
    font-weight: normal;
    font-size: 4em;
    margin: 0 0 0;
    color: #444;
}
.back {
    stroke: #fff;
    stroke-width: 4;
}

path {
    fill: none;
    stroke-width: 2;
}

path.label {
    stroke-width: 5;
}
path.max {
    fill: #88f;
    stroke: none;
}
path.min {
    fill: #fff;
    stroke: none;
}
path.med {
    fill: none;
    stroke: #00f;
    stroke-linecap: round;
}

.Au {
    stroke: #f00;
}
.Be {
    stroke: #000;
}
.Fi {
    stroke: #f60;
}
.Fr {
    stroke: #060;
}
.Ge {
    stroke: #390;
}
.Gr {
    stroke: #906;
}
.Ir {
    stroke: #990;
}
.It {
    stroke: #f3c;
}
.Lu {
    stroke: #ff0;
}
.Ne {
    stroke: #930;
}
.Po {
    stroke: #666;
}
.Sp {
    stroke: #0f0;
}
.hidden {
    stroke: none;
}

.ui-widget-content { border: 1px solid #444; background: #aaa; color: #333; }
.ui-widget-content a { color: #333; }
.ui-state-default, .ui-widget-content .ui-state-default, .ui-widget-header .ui-state-default { border: 1px solid #444; background: #aaa; font-weight: bold; color: #333; }
.ui-state-hover, .ui-widget-content .ui-state-hover, .ui-widget-header .ui-state-hover, .ui-state-focus, .ui-widget-content .ui-state-focus, .ui-widget-header .ui-state-focus { border: 1px solid #444; background: #ccc; font-weight: bold; color: #333; }
.ui-state-active, .ui-widget-content .ui-state-active, .ui-widget-header .ui-state-active { border: 1px solid #444; background: #ccc; font-weight: bold; color: #333; } .ui-state-active a, .ui-state-active a:link, .ui-state-active a:visited { color: #333; text-decoration: none; }

.ui-slider { position: relative; text-align: left; }
.ui-slider .ui-slider-handle { position: absolute; z-index: 2; width: 1.2em; height: 1.2em; cursor: default; }
.ui-slider .ui-slider-range { position: absolute; z-index: 1; font-size: .7em; display: block; border: 0; background-position: 0 0; }

.ui-slider-horizontal { height: .8em; }
.ui-slider-horizontal .ui-slider-handle { top: -.3em; margin-left: -.6em; }
.ui-slider-horizontal .ui-slider-range { top: 0; height: 100%; }
.ui-slider-horizontal .ui-slider-range-min { left: 0; }
.ui-slider-horizontal .ui-slider-range-max { right: 0; }
        </style>
    </head>

    <body>
        <h1>Components of a crisis</h1>
        <div style="position: relative; height: 70%;">
            <table style="padding: 10px; border-spacing: 10px;" id="cselector">
            </table>
        </div>
        <div id="timelabel" class="timelabel" style="position: relative;">
        </div>
        <div style="position: fixed; left: 30%; top: 10px; bottom: 50px;">
            <div id="graph"></div>
            <div style="position: relative; top: -30px;">
                <button id="pcontrol" style="position: relative; top: 10px;">
                    play
                </button>
                <div id="slider" style="left: 80px; width: 90%;"></div>
            </div>
        </div>
        <div style="position: fixed; bottom: 10px; left: 10px;">
            Data from ECB, EuroStat, IMF, OECD, World Bank
        </div>
        <div style="position: fixed; bottom: 10px; right: 10px;">
            Lars Kotthoff 2011
        </div>
        <script type="text/javascript">
        (function () {
        var margin = 30,
            aduration = 750,
            playing = false,
            idformat = d3.time.format("%Y/%m"),
            odformat = d3.time.format("%B %Y"),
            countries = ["Austria", "Belgium", "Finland", "France", "Germany",
                "Greece", "Ireland", "Italy", "Luxembourg", "Netherlands",
                "Portugal", "Spain"],
            measures = ["debt", "int", "def", "gdpd", "inv", "inf",
                "unemp"]
            labels = ["Debt [%GDP]",
                "Interest [%]", "Surplus [%GDP]", "GDP growth [%]",
                "Investments [%GDP]", "Inflation [%]", "Unemployment [%]"]
            width = window.innerWidth * 0.7,
            height = window.innerHeight - 60,
            r = (d3.min([width, height]) / 2) - 2 * margin,
            svg = d3.select("#graph")
                .append("svg:svg")
                .attr("height", height)
                .attr("width", width),
            ctr = svg.append("svg:g").attr("transform", "translate(" + width/2 +
                "," + height/2 + ")");

        $.each(countries, function(i, c) {
            var cid = c.substr(0, 2),
                tr = d3.select("#cselector").append("tr");
            tr.append("td").append("input")
                .attr("type", "checkbox")
                .on("click", function() { toggleCLine(cid); });
            tr.append("td").style("font-size", "larger").html(c);
            tr.append("td").append("svg:svg")
                .attr("width", 20).attr("height", 5)
                .append("svg:path")
                .attr("d", "M0,2 20,2")
                .attr("class", cid + " label hidden");
        });

        function toggleCLine(cid) {
            var p = d3.selectAll("." + cid),
                c = p.classed("hidden");
            p.classed("hidden", c ^ true);
        }

        function vf(f) {
            if(f >= 100 || f <= -100) {
                return Math.round(f);
            } else {
                return f.toFixed(1);
            }
        }

        function fd(ds) {
            return odformat(idformat.parse(ds));
        }

        d3.json("eu.json", function(json) {
            var minses = $.map(measures, function(m) {
                    return d3.min($.map(json, function(d) {
                        return d[1][m].min;
                    }));
                }),
                maxes = $.map(measures, function(m) {
                    return d3.max($.map(json, function(d) {
                        return d[1][m].max;
                    }));
                }),
                scales = $.map(measures, function(m, i) {
                    return d3.scale.linear()
                        .domain([minses[i], maxes[i]])
                        .range([margin, r]);
                });

            function angle(i) {
                return i * (2 * Math.PI / measures.length) +
                    Math.PI/measures.length;
            }

            function line(f) {
                return d3.svg.line()
                    .x(function(e, i) {
                        var l = scales[i%measures.length](f(e.value));
                        return Math.sin(angle(i)) * l;
                    })
                    .y(function(e, i) {
                        var l = scales[i%measures.length](f(e.value));
                        return Math.cos(angle(i)) * l;
                    });
            }

            function update(idx, delay) {
                setTimeout(function() {
                    d3.select("#timelabel").html(fd(json[idx][0]));
                }, delay);
                var dat = d3.entries(json[idx][1]).sort(function(a, b) {
                    return measures.indexOf(a.key) -
                            measures.indexOf(b.key);
                });
                $.each(["max", "min", "med"], function(j, m) {
                    ctr.selectAll("path." + m)
                        .data([dat.concat(dat[0])])
                        .transition().duration(delay)
                        .attr("d", line(function(d) { return d[m]; }));
                });
                $.each(countries, function(j, c) {
                    var cls = c.substr(0, 2);
                    ctr.selectAll("path." + cls)
                        .data([dat.concat(dat[0])])
                        .transition().duration(delay)
                        .attr("d", line(function(d) { return d[cls]; }));
                });
                $.each(["max", "min"], function(j, m) {
                    ctr.selectAll("g." + m)
                        .data(dat)
                        .transition().duration(delay)
                        .attr("transform", function(d, i) {
                            var l = scales[i](d.value[m]) +
                                    (j == 0 ? margin : -margin) / 3,
                                x = Math.sin(angle(i)) * l,
                                y = Math.cos(angle(i)) * l;
                            return "translate(" + x + "," + y + ")";
                        });
                     ctr.selectAll("text.back." + m)
                        .data(dat)
                        .text(function(d) { return vf(d.value[m]); });
                     ctr.selectAll("text.front." + m)
                        .data(dat)
                        .text(function(d) { return vf(d.value[m]); });
                });
            }

            d3.select("#timelabel").html(fd(json[0][0]));
            var dat = d3.entries(json[0][1]).sort(function(a, b) {
                return measures.indexOf(a.key) - measures.indexOf(b.key);
            });
            $.each(["max", "min", "med"], function(j, m) {
                ctr.selectAll("path." + m)
                    .data([dat.concat(dat[0])])
                    .enter()
                    .append("svg:path")
                    .attr("class", m)
                    .attr("d", line(function(d) { return d[m]; }));
            });
            $.each(countries, function(j, c) {
                var cls = c.substr(0, 2);
                ctr.selectAll("path." + cls)
                    .data([dat.concat(dat[0])])
                    .enter()
                    .append("svg:path")
                    .attr("class", cls + " hidden")
                    .attr("d", line(function(d) { return d[cls]; }));
            });

            ctr.append("svg:circle")
                .attr("class", "mark")
                .attr("r", 2)
                .attr("transform", function() {
                    var i = measures.indexOf("def"),
                        l = scales[i](-3),
                        x = Math.sin(angle(i)) * l,
                        y = Math.cos(angle(i)) * l;
                    return "translate(" + x + "," + y + ")";
                });
            ctr.append("svg:circle")
                .attr("class", "mark")
                .attr("r", 2)
                .attr("transform", function() {
                    var i = measures.indexOf("debt"),
                        l = scales[i](60),
                        x = Math.sin(angle(i)) * l,
                        y = Math.cos(angle(i)) * l;
                    return "translate(" + x + "," + y + ")";
                });

            $.each(["max", "min"], function(j, m) {
                var sel = ctr.selectAll("g." + m)
                    .data(dat)
                    .enter()
                    .append("svg:g")
                    .attr("class", m)
                    .attr("transform", function(d, i) {
                        var l = scales[i](d.value[m]) +
                                (j == 0 ? margin : -margin) / 3,
                            x = Math.sin(angle(i)) * l,
                            y = Math.cos(angle(i)) * l;
                        return "translate(" + x + "," + y + ")";
                    });
                sel.append("svg:text")
                    .attr("class", m + " back")
                    .attr("text-anchor", "middle")
                    .text(function(d) { return vf(d.value[m]); });
                sel.append("svg:text")
                    .attr("class", m + " front")
                    .attr("text-anchor", "middle")
                    .text(function(d) { return vf(d.value[m]); });
            });

            ctr.selectAll("text.label")
                .data(labels)
                .enter()
                .append("svg:text")
                .attr("class", "label")
                .attr("transform", function(d, i) {
                    var x = Math.sin(angle(i)) * (r + 1.5 * margin),
                        y = Math.cos(angle(i)) * (r + 1.5 * margin);
                    return "translate(" + x + "," + y + ")";
                })
                .attr("text-anchor", function(d, i) {
                    if(angle(i) % Math.PI == 0) {
                        return "middle";
                    } else if(angle(i) < Math.PI) {
                        return "start";
                    } else {
                        return "end";
                    }
                })
                .text(function(d) { return d; });

            // slider setup
            $("#slider").slider({
                min: 0,
                max: json.length-1,
                slide: function(ev, ui) {
                    stopPlay();
                    update(ui.value, 0);
                },
                change: function(ev, ui) {
                    update(ui.value, aduration);
                }
            });
            var prevyear = "";
            $.each(json, function(i, d) {
                var year = d[0].substr(0, 4);
                if(year != prevyear) {
                    $("#slider").append(
                        '<div class="ui-slider-label" ' +
                        'style="position: absolute; bottom: 20px; left:' +
                        (i*100/json.length) + '%">' + year + '</div>');
                    prevyear = year;
                }
            });
            $("#slider")
                .find('.ui-slider-label')
                .each(function(){
                    $(this).css('marginLeft', -$(this).width()/2);
                });

            function nextFrame() {
                var idx = $("#slider").slider("value");
                if(playing && idx < json.length) {
                    $("#slider").slider("value", idx + 1);
                    setTimeout(function() { nextFrame(); }, aduration);
                }
                if(idx == json.length-1) {
                    stopPlay();
                }
            }
            function stopPlay() {
                playing = false;
                $("#pcontrol").html("play");
            }
            function togglePlay() {
                if(playing) {
                    stopPlay();
                } else {
                    var idx = $("#slider").slider("value");
                    if(idx == json.length-1) {
                        $("#slider").slider("value", 0);
                    }
                    playing = true;
                    $("#pcontrol").html("stop");
                    nextFrame();
                }
            }
            d3.select("#pcontrol").on("click", togglePlay);
        });
        })();
        </script>
    </body>
</html>
