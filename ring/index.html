<!DOCTYPE html>
<html>
    <head>
        <title>Euro crisis</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <script type="text/javascript" src="../../d3.min.js"></script>
        <script type="text/javascript" src="../../d3.layout.min.js"></script>
        <script type="text/javascript" src="../../d3.time.min.js"></script>
        <script type="text/javascript" src="../../jquery-1.6.2.min.js"></script>
        <style type="text/css"> 
body {
    font: 12px Verdana, Palatino, Helvetica, sans;
}
h1 {
    font-weight: normal;
    font-size: 4em;
    margin: 0 0 0;
}
.timelabel {
    font-weight: normal;
    font-size: 4em;
    margin: 0 0 0;
    color: #444;
}
path.max {
    fill: #88f;
    stroke: none;
}
path.min {
    fill: #fff;
    stroke: none;
}
path.med {
    fill: none;
    stroke: #f00;
    stroke-width: 2;
    stroke-linecap: round;
}
.tick {
  stroke: #000;
  stroke-width: 1;
  fill: none;
}
.domain {
  stroke-width: 2;
  fill: none;
  stroke: #000;
  fill: none;
}
.title {
    font-weight: bold;
}
        </style>
    </head>

    <body>
        <div style="position: fixed; top: 10px; left: 10px; right: 70%;">
            <h1>Euro crisis</h1>
        </div>
        <div id="timelabel" class="timelabel" style="position: fixed; left: 10px; bottom: 10%;">
        </div>
        <div id="graph" style="position: fixed; left: 30%;"></div>
        <div style="position: fixed; bottom: 10px; left: 10px;">
            Data from ECB, EuroStat, IMF, OECD, World Bank
        </div>
        <div style="position: fixed; bottom: 10px; right: 10px;">
            Lars Kotthoff 2011
        </div>
        <script type="text/javascript">
        (function () {
        var margin = 30,
            aduration = 750,
            idformat = d3.time.format("%Y/%m"),
            odformat = d3.time.format("%B %Y"),
            countries = ["Austria", "Belgium", "Finland", "France", "Germany",
                "Greece", "Ireland", "Italy", "Luxembourg", "Netherlands",
                "Portugal", "Spain"],
            measures = ["debt", "int", "def", "gdpd", "inv", "inf",
                "unemp"]
            labels = ["Debt [%GDP]",
                "Interest [%]", "Surplus [%GDP]", "GDP growth [%]",
                "Investments [%GDP]", "Inflation [%]", "Unemployment [%]"]
            width = window.innerWidth * 0.7,
            height = window.innerHeight,
            r = (d3.min([width, height]) / 2) - 2 * margin,
            svg = d3.select("#graph")
                .append("svg:svg")
                .attr("height", height)
                .attr("width", width),
            ctr = svg.append("svg:g").attr("transform", "translate(" + width/2 +
                "," + height/2 + ")");

        function vf(f) {
            if(f >= 100 || f <= -100) {
                return Math.round(f);
            } else {
                return f.toFixed(1);
            }
        }

        function fd(ds) {
            return odformat(idformat.parse(ds));
        }

        d3.json("eu.json", function(json) {
            var minses = $.map(measures, function(m) {
                    return d3.min($.map(json, function(d) {
                        return d[1][m].min;
                    }));
                }),
                maxes = $.map(measures, function(m) {
                    return d3.max($.map(json, function(d) {
                        return d[1][m].max;
                    }));
                }),
                scales = $.map(measures, function(m, i) {
                    return d3.scale.linear()
                        .domain([minses[i], maxes[i]])
                        .range([margin, r]);
                });

            function angle(i) {
                return i * (2 * Math.PI / measures.length) +
                    Math.PI/measures.length;
            }

            function line(f) {
                return d3.svg.line()
                    .x(function(e, i) {
                        var l = scales[i%measures.length](f(e.value));
                        return Math.sin(angle(i)) * l;
                    })
                    .y(function(e, i) {
                        var l = scales[i%measures.length](f(e.value));
                        return Math.cos(angle(i)) * l;
                    });
            }

            function update(idx) {
                setTimeout(function() {
                    d3.select("#timelabel").html(fd(json[idx][0]));
                }, aduration);
                var dat = d3.entries(json[idx][1]).sort(function(a, b) {
                    return measures.indexOf(a.key) -
                            measures.indexOf(b.key);
                });
                $.each(["max", "min", "med"], function(j, m) {
                    ctr.selectAll("path." + m)
                        .data([dat.concat(dat[0])])
                        .transition().duration(aduration)
                        .attr("d", line(function(d) { return d[m]; }));
                });
                $.each(["max", "min"], function(j, m) {
                    ctr.selectAll("text." + m)
                        .data(dat)
                        .transition().duration(aduration)
                        .attr("transform", function(d, i) {
                            var l = scales[i](d.value[m]) +
                                    (j == 0 ? margin : -margin) / 2,
                                x = Math.sin(angle(i)) * l,
                                y = Math.cos(angle(i)) * l;
                            return "translate(" + x + "," + y + ")";
                        })
                        .text(function(d) { return vf(d.value[m]); });
                });
            }

            d3.select("#timelabel").html(fd(json[0][0]));
            var dat = d3.entries(json[0][1]).sort(function(a, b) {
                return measures.indexOf(a.key) - measures.indexOf(b.key);
            });
            $.each(["max", "min", "med"], function(j, m) {
                ctr.selectAll("path." + m)
                    .data([dat.concat(dat[0])])
                    .enter()
                    .append("svg:path")
                    .attr("class", m)
                    .attr("d", line(function(d) { return d[m]; }));
            });

            ctr.append("svg:circle")
                .attr("class", "mark")
                .attr("r", 2)
                .attr("transform", function() {
                    var i = measures.indexOf("def"),
                        l = scales[i](-3),
                        x = Math.sin(angle(i)) * l,
                        y = Math.cos(angle(i)) * l;
                    return "translate(" + x + "," + y + ")";
                });
            ctr.append("svg:circle")
                .attr("class", "mark")
                .attr("r", 2)
                .attr("transform", function() {
                    var i = measures.indexOf("debt"),
                        l = scales[i](60),
                        x = Math.sin(angle(i)) * l,
                        y = Math.cos(angle(i)) * l;
                    return "translate(" + x + "," + y + ")";
                });

            $.each(["max", "min"], function(j, m) {
                ctr.selectAll("text." + m)
                    .data(dat)
                    .enter()
                    .append("svg:text")
                    .attr("class", m)
                    .attr("transform", function(d, i) {
                        var l = scales[i](d.value[m]) +
                                (j == 0 ? margin : -margin) / 2,
                            x = Math.sin(angle(i)) * l,
                            y = Math.cos(angle(i)) * l;
                        return "translate(" + x + "," + y + ")";
                    })
                    .attr("text-anchor", "middle")
                    .text(function(d) { return vf(d.value[m]); });
            });

            ctr.selectAll("text.label")
                .data(labels)
                .enter()
                .append("svg:text")
                .attr("class", "label")
                .attr("transform", function(d, i) {
                    var x = Math.sin(angle(i)) * (r + 1.5 * margin),
                        y = Math.cos(angle(i)) * (r + 1.5 * margin);
                    return "translate(" + x + "," + y + ")";
                })
                .attr("text-anchor", function(d, i) {
                    if(angle(i) % Math.PI == 0) {
                        return "middle";
                    } else if(angle(i) < Math.PI) {
                        return "start";
                    } else {
                        return "end";
                    }
                })
                .text(function(d) { return d; });

            (function next(idx) {
                if(idx < json.length) {
                    update(idx);
                    setTimeout(function() { next(idx + 1); }, aduration);
                }
            })(1);
        });
        })();
        </script>
    </body>
</html>
